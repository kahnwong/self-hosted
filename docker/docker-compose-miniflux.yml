---
version: '3.3'

services:
  ## init
  # docker-compose up db
  # docker-compose up miniflux

  ## restore
  # start db container first, pg_restore and reset admin password

  miniflux_db:
    container_name: miniflux_db
    image: postgres:15.1-alpine
    environment:
      POSTGRES_USER: miniflux
      POSTGRES_PASSWORD: secret
    volumes:
      - /opt/miniflux/db:/var/lib/postgresql/data
    restart: always
    networks:
      - miniflux

  miniflux:
    container_name: miniflux
    image: miniflux/miniflux:2.0.40
    ports:
      - 350:8080
    depends_on:
      - miniflux_db
    environment:
      DATABASE_URL: postgres://miniflux:secret@miniflux_db/miniflux?sslmode=disable
      RUN_MIGRATIONS: 1
      CREATE_ADMIN: 1
      ADMIN_USERNAME: ${MINIFLUX_USER}
      ADMIN_PASSWORD: ${MINIFLUX_PASSWORD}
      BASE_URL: https://miniflux.karnwong.me
      POLLING_FREQUENCY: 60
      BATCH_SIZE: 300
      POLLING_SCHEDULER: entry_frequency
      SCHEDULER_ENTRY_FREQUENCY_MIN_INTERVAL: 5
      SCHEDULER_ENTRY_FREQUENCY_MAX_INTERVAL: 24*60
    restart: always
    env_file: .miniflux.env
    networks:
      - miniflux

networks:
  miniflux:
    driver: bridge
