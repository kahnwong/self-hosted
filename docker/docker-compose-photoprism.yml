---
version: '3.5'

# MYSQL DOESN'T WORK WITH ENV FILE
# change ADMIN_PASSWORD via the web ui, see env file
services:
  photoprism:
    container_name: photoprism
    image: photoprism/photoprism:latest
    depends_on:
      - mariadb
    restart: always
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    ports:
      - 2342:2342
    environment:
      PHOTOPRISM_ADMIN_PASSWORD: photoprism
      PHOTOPRISM_DATABASE_DRIVER: mysql # Use MariaDB 10.5+ or MySQL 8+ instead of SQLite for improved performance
      PHOTOPRISM_DATABASE_SERVER: mariadb:3306 # MariaDB or MySQL database server (hostname:port)
      PHOTOPRISM_DATABASE_NAME: photoprism # MariaDB or MySQL database schema name
      PHOTOPRISM_DATABASE_USER: photoprism # MariaDB or MySQL database user name
      PHOTOPRISM_DATABASE_PASSWORD: insecure # MariaDB or MySQL database user password
      HOME: /photoprism
    env_file: .photoprism.env
    working_dir: /photoprism
    volumes:
      - /opt/photoprism/images:/photoprism/originals
      - /opt/photoprism/storage:/photoprism/storage
    networks:
      - photoprism

  mariadb:
    container_name: photoprism_db
    restart: always
    image: mariadb:10.9
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    command: mysqld --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max-connections=512 --innodb-rollback-on-timeout=OFF
      --innodb-lock-wait-timeout=120
    volumes:
      - /opt/photoprism/db:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: insecure
      MYSQL_DATABASE: photoprism
      MYSQL_USER: photoprism
      MYSQL_PASSWORD: insecure
    networks:
      - photoprism

networks:
  photoprism:
    driver: bridge
